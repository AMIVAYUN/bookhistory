# Chapter 4. 성능 테스트 및 안티 패턴

# 성능 테스트의 유형

<aside>
💡

뭐라도 하는 게 아무것도 안 하는 것보단 낫지 않나 라는 믿음으로 테스트를 진행하면 위험도만 높임을 숙지하고 진행.

</aside>

## 지연 테스트

<aside>
💡

일반적인 성능 테스트이다. 고객의 사용자 경험에 가장 가까운 영역이기도 latcency를 다루는 영역

</aside>

허나 유의점은 애플리케이션의 요청 응답성을 측정하여 평균 값을 내는 것은 지표로 큰 소용이 없다. → 기반 환경의 존재를 고려하여야 한다.

## 처리율 테스트

<aside>
💡

일반적인 성능 테스트로 어떤 측면에서 지연과 동등한 개념이다.

</aside>

지연 테스트는 수행시 계속 진행중인 동시 트랜잭션을 반드시 명시해야 한다. 마찬가지로, 처리율 역시 지연을 모니터링하면서 테스트한다.

이러한 상황에서 변곡점( 시스템 한계점 )을 찾아서 이 점을 최대 처리율로 정의하는 것.

## 부하 테스트

<aside>
💡

부하 테스트는 처리율과 다르게 시스템이 이 정도 부하는 견딜 수 있을까? 없을까? 하는 답을 구하는 과정이다. 

</aside>

특정 비즈니스 이벤트( 광고, 소셜 미디어 이벤트, 바이럴 콘텐츠 )등을 대비하기 위해 수행한다.

## 스트레스 테스트

<aside>
💡

시스템 여력이 얼마정도인지 알아보는 테스트, 지속적으로 서비스에 부하를 가해 어느정도까지 성능 저하 없이 견디는지 체크하는 것.

</aside>

보통 일정 수준의 트랜잭션을 시스템에 계속 걸어둔다. 시간이 가면 동시 트랜잭션이 증가하고 시스템 성능은 저하된다. 이 점이 위의 처리율 테스트의 최대 처리율 지점이 된다.

## 내구 테스트

<aside>
💡

메모리 누수, 캐시 오염, 메모리 단편화등 애플리케이션의 실행 간 생기는 문제점들을 찾고자 하는 테스트

</aside>

시간이 지나고 나서야 드러나는 문제점도 있기에 주기적으로 테스트 하기도 하며 이를 흡수 테스트 라고도 한다.

평균보다 높은 사용률로 시스템에 일정 부하를 계속 주며 모니터링하다가 갑자기 리소스가 고갈되거나 시스템이 깨지는 지점을 찾는 방법.

내구 테스트는 빠른 응답을 요구하는 시스템에서 많이 진행하게 된다.

## 용량 계획 테스트

<aside>
💡

스트레스 테스트와 여러모로 비슷하지만 이 테스트는 업그레이드한 시스템이 어느 정도 부하를 감당할 수 있을지 미리 내다보는 것이다.

</aside>

즉, 현재 시스템 기준이 아닌 계획한 차후 시스템의 구성에 대한 논의를 위해 실행하는 테스트이다.

## 저하 테스트

<aside>
💡

저하 테스트는 부분 실패 테스트라고도 한다. 복원성( resilience )이나 장애 극복( failover ) 등을 체크하는 복원 테스트도 저하 테스트의 일부이다.

</aside>

평상시 운영 환경과 동등한 수준의 부하를 시스템에 가하는 도중에 어떤 컴포넌트나 전체 서브 시스템이 갑자기 능력을 상실하는 시점에 벌어지는 일들을 체크하는 것이다.

이에 대한 예시중 하나는 카오스 멍키가 있는데, 넷플릭스에서 자신들의 아키텍쳐의 복원성을 검증하기 위해 수행한 프로젝트.

---

# 테스트의 기본 프랙티스

1. 나의 관심사가 무엇인지 식별하고 측정 방법을 고민할 것.
2. 최적화하기 용이한 부분이 아니라 중요한 부분을 최적화할 것.
3. 중요 관심사 먼저 다룰 것.

## 하향식 성능

<aside>
💡

전체 애플리케이션의 성능 양상부터 알아보는 접근 방식을 하향식 성능이라고 한다.

</aside>

## 성능 요건 식별

<aside>
💡

전체 시스템의 성능은 애플리케이션 뿐만 아니라 컨테이너, OS, 하드웨어 모두 영향을 끼침.

</aside>

성능 평가 지표는 코드 관점에서만 생각해서도 안되고 시스템을 전체적으로 바라보면서 고객과 경영진에게 중요한 측정값을 제공하는 것이 주요 관점이다.

이렇게 최적화 하려는 핵심 지표를 **NFR** 이른 바, **성능 비기능 요건** 이라고 한다.

### 자바의 특정 이슈

- 자바는 메모리 영역의 동적 튜닝과 같은 JVM특유의 동적 자기 관리 기능에 의해 다른 언어들에 비해 성능 면에서 지표를 확인할 때 복잡하다.
- JIT 컴파일러는 이런 과정에서 중요한 부분이며 실제 측정시 어떤 메서드가 컴파일 중인지 로그를 남겨 살피고 핵심 코드 경로상의 중요 메서드가 잘 컴파일되고 있는지 확인하는 것이다.

# 안티패턴

## 안티패턴이란?

<aside>
💡

소프트웨어 프로젝트 팀에서 통상적으로 발견되는 좋지 않은 패턴들을 일괄적으로 묶어 안티패턴이라고 한다.

</aside>

## 성능 안티패턴 카탈로그

### 화려함에 사로잡히는 것

최신 멋진 기술을 튜닝 타깃으로 정하는 것.

- 신 기술에 대한 측정 및 성능 병목점 찾기
- 새 컴포넌트는 추가적으로 로그를 남겨 사고를 미연에 방지
- 단순화한 데모 코드 및 베스트 프랙티스 참조
- 팀원들이 신 기술들을 이해할 수 있도록 독려하고, 베스트 프랙티스 수준을 정할 것.

### 단순함에 사로잡히는 것

애플리케이션 프로파일링을 통해 객관적으로 아픈 부위를 들추지 않고, 무작정 시스템에서 제일 간단한 부분만 파고드는 것.

- 측정 및 병목점 찾기
- 본인이 익숙지 않은 컴포넌트의 담당시 잘 아는 전문가를 찾기
- 또한 2번과 같은 일이 반복되지 않도록 전체 시스템 컴포넌트를 고루 이해하도록 기본적인 자세가 필요
- 기존 개발자의 커밋 로그 및 개발 내역을 보며 변경점에 대한 트래킹

### 성능 튜닝 도사 찾기

외부 전문 업체에 맡겨 모든 문제를 해결하고자 하는 것.

이는 결과적으로 자사 서비스에 대한 개발자들의 이해도를 낮추어 근시안적으로는 해결되나 시간이 흐름에 따라 위험도가 높아진다.

- 각 영역별 팀내 개발자로 하여금 시스템에 대한 이해와 지식 공유가 기본적으로 전제되어야 한다.

### 민간 튜닝

서비스 중 발생한 성능 문제를 해결하려고 안간힘을 쓰던 중, 한 팀원이 웹사이트에서 마법의 매개변수를 발견한다. → 이를 적용하면…

성능 튜닝 도사의 민간 요법 버전이다.

- 시스템에 가장 중요한 부분에 직접 영향을 미치는 기술은 확실히 파악하고 충분히 검증된 것들만 적용할 것
- 매개변수를 UAT( 사용자 인수 테스트 )에서 시험해볼 것
- 단순 적용이 아닌 다른 개발자, 운영 요원, 데브옵스팀과 함께 설정 문제를 리뷰하고 토의할 것.

### 안되면 조상 탓

정작 이슈와 상관없는 특정 컴포넌트를 문제 삼는 것. 하이버네이트가 문제니.. 역시 그 머시기 라이브러리가 문제였다느니 등등

- 정상적인 분석 먼저 실시
- 분석 결과를 혼자 해결하는게 아니라 모든 이해관계자와 논의할 것.

### 숲을 못보고 나무만 보다

흔히 개발이 진행될수록 반복되는 문제중 하나로 전체적인 변경 영향에 대해 고려하지 않고 일단 그냥 변경을 시도하거나 변경을 하여도 국소적인 부분만 프로파일링 하는 것.

자바로 치면 자바의 GC 스위치는 수백개에 달한다. 런타임에서 자유자재로 설정 가능한 장점이 있지만, 역으로 이를 전부 이해하고 활용하는 개발자는 불가능하다는 것을 알아두어야 한다.

1. 변경후 운영계의 성능 지표를 꼭 측정할 것
2. 파라미터가 여러개일 시 이를 분할하여 각각 한개씩 측정 후 병렬적으로 합쳐가면서 모든 결과값에 대한 안정성을 논의할 것

### 내 데스크톱이 UAT

흔히 운영환경에 대한 이해 없이 내 환경이 비슷하다하여, 개발자 환경에서 처리 후 내려버리는 것.

- 올바른 레퍼런스와 실제 운영환경에 대한 이해 필요
- 서비스 중단 비용, 고객 이탈 비용에 대해 고려할 것.

### 운영 데이터처럼 만들기는 어려워

흔히 데이터라이트 라고도 하는 이 안티 패턴은 사람들이 운영계와 유사한 데이터를 나타내고자 할 때 빠지는 함정.

- 데이터 도메인 전문가에게 컨설팅을 받고 운영 데이터를 UAT로 다시 이전하는 프로세스에 시간과 노력을 투자
- 특히 엄청난 트랜잭션이 예상된다면 서비스 출시 전 철저히 준비할 것.